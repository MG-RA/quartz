#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"

IRREV_WIN="$REPO_ROOT/irrev/.venv/Scripts/irrev.exe"
IRREV_POSIX="$REPO_ROOT/irrev/.venv/bin/irrev"
REGISTRY_NOTE_REL="content/papers/Irreversibility Accounting (Registry).md"

is_wsl() {
  [[ -r /proc/version ]] && grep -qiE 'microsoft|wsl' /proc/version
}

to_windows_path() {
  local p="$1"
  if command -v wslpath >/dev/null 2>&1; then
    wslpath -w "$p"
    return 0
  fi
  if command -v cygpath >/dev/null 2>&1; then
    cygpath -w "$p"
    return 0
  fi
  # Best effort: already might be C:/... in some shells.
  echo "$p"
}

IRREV_BIN=""
VAULT_PATH=""

if [[ -x "$IRREV_POSIX" ]]; then
  IRREV_BIN="$IRREV_POSIX"
  VAULT_PATH="$REPO_ROOT/content"
elif [[ -f "$IRREV_WIN" ]]; then
  IRREV_BIN="$IRREV_WIN"
  VAULT_PATH="$(to_windows_path "$REPO_ROOT/content")"
elif command -v irrev >/dev/null 2>&1; then
  IRREV_BIN="$(command -v irrev)"
  VAULT_PATH="$REPO_ROOT/content"
else
  echo "pre-commit: irrev not found." >&2
  echo "pre-commit: expected $IRREV_POSIX or $IRREV_WIN, or 'irrev' on PATH." >&2
  echo "pre-commit: install the irrev venv (cd irrev && uv sync) or adjust the hook." >&2
  exit 1
fi

echo "pre-commit: updating registry tables..."
"$IRREV_BIN" -v "$VAULT_PATH" registry build --in-place

git add "$REGISTRY_NOTE_REL" 2>/dev/null || true

echo "pre-commit: running vault lint..."
"$IRREV_BIN" -v "$VAULT_PATH" lint
